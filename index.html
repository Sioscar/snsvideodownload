<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>短视频去水印解析工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .video-container video {
            max-height: 500px;
            width: 100%;
            border-radius: 12px;
            background: #000;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800 flex flex-col">

    <!-- 导航栏/头部 -->
    <nav class="p-4 flex justify-end">
        <button onclick="toggleSettings()" class="text-gray-400 hover:text-blue-600 transition-colors p-2" title="配置 API 秘钥">
            <i class="fas fa-cog text-xl"></i>
        </button>
    </nav>

    <div class="flex-grow max-w-4xl mx-auto px-4 py-4 w-full">
        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-video text-blue-600 mr-2"></i>短视频去水印解析
            </h1>
            <p class="text-gray-500 text-sm">支持抖音、小红书、快手等平台 | 个人私有化部署版</p>
        </div>

        <!-- 秘钥配置区域 (默认隐藏) -->
        <div id="settingsPanel" class="hidden glass-morphism p-6 rounded-2xl shadow-lg mb-8 border-2 border-blue-100">
            <h3 class="font-bold mb-4 flex items-center gap-2">
                <i class="fas fa-key text-yellow-500"></i> API 秘钥配置
            </h3>
            <div class="flex flex-col md:flex-row gap-4">
                <input 
                    type="password" 
                    id="apiTokenInput" 
                    placeholder="请输入您的下载狗 API Token"
                    class="flex-1 px-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <button 
                    onclick="saveToken()" 
                    class="bg-gray-800 hover:bg-black text-white px-6 py-2 rounded-lg transition-all"
                >保存设置</button>
            </div>
            <p class="mt-2 text-xs text-gray-400 italic">* 秘钥将保存在浏览器本地，不会上传到 GitHub 仓库。</p>
        </div>

        <!-- 输入区域 -->
        <div class="glass-morphism p-6 rounded-2xl shadow-xl mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <input 
                    type="text" 
                    id="videoUrl" 
                    placeholder="请粘贴分享链接..."
                    class="flex-1 px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                >
                <button 
                    onclick="parseVideo()" 
                    id="parseBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-medium transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2"
                >
                    <i class="fas fa-magic"></i> 立即解析
                </button>
            </div>
            <div class="mt-3 flex items-center gap-2 text-xs text-gray-400">
                <input type="checkbox" id="useProxy" checked>
                <label for="useProxy">使用中转代理模式（解决跨域限制）</label>
            </div>
        </div>

        <!-- 加载中 -->
        <div id="loading" class="hidden flex-col items-center justify-center py-20">
            <div class="loading-spinner mb-4"></div>
            <p id="loadingStatus" class="text-gray-500">正在努力解析中...</p>
        </div>

        <!-- 结果展示区域 -->
        <div id="result" class="hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="video-container rounded-2xl overflow-hidden shadow-2xl flex items-center justify-center">
                    <video id="player" controls poster="" class="w-full h-full" playsinline>
                        您的浏览器不支持视频播放
                    </video>
                </div>

                <div class="space-y-6 flex flex-col justify-between">
                    <div>
                        <h2 id="title" class="text-xl font-semibold leading-relaxed mb-4">视频标题加载中...</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                <p class="text-gray-400 mb-1"><i class="fas fa-heart mr-1"></i> 点赞数</p>
                                <p id="likes" class="text-lg font-bold text-red-500">0</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                <p class="text-gray-400 mb-1"><i class="fas fa-clock mr-1"></i> 发布时间</p>
                                <p id="createTime" class="text-lg font-bold text-gray-700">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <button onclick="downloadVideo()" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg active:scale-95">
                            <i class="fas fa-download"></i> 下载无水印视频
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 错误提示 -->
        <div id="errorBox" class="hidden bg-red-50 text-red-600 p-4 rounded-xl border border-red-200 text-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorMsg"></span>
        </div>
    </div>

    <footer class="py-6 text-center text-gray-400 text-xs mt-auto">
        <span id="quotaInfo" class="hidden">API 剩余解析次数: <span id="leftTimes">0</span></span>
        <p class="mt-1">本工具仅供学习交流使用</p>
    </footer>

    <script>
        const TARGET_URL = "https://www.xiazaitool.com/api/parseVideoUrl";
        const PROXY_URL = "https://corsproxy.io/?"; 
        let currentVideoUrl = "";

        // 初始化：检查本地是否有保存的 Token
        window.onload = () => {
            const savedToken = localStorage.getItem('DOG_API_TOKEN');
            if (!savedToken) {
                document.getElementById('settingsPanel').classList.remove('hidden');
            } else {
                document.getElementById('apiTokenInput').value = savedToken;
            }
        };

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        function saveToken() {
            const token = document.getElementById('apiTokenInput').value.trim();
            if (!token) {
                alert("请输入有效的 Token");
                return;
            }
            localStorage.setItem('DOG_API_TOKEN', token);
            alert("秘钥保存成功！");
            document.getElementById('settingsPanel').classList.add('hidden');
        }

        async function parseVideo() {
            const input = document.getElementById('videoUrl').value.trim();
            const useProxy = document.getElementById('useProxy').checked;
            const btn = document.getElementById('parseBtn');
            const resultDiv = document.getElementById('result');
            const loading = document.getElementById('loading');
            const errorBox = document.getElementById('errorBox');
            
            const API_TOKEN = localStorage.getItem('DOG_API_TOKEN');

            if (!API_TOKEN) {
                document.getElementById('settingsPanel').classList.remove('hidden');
                showError("请先点击右上角齿轮设置您的 API 秘钥");
                return;
            }

            if (!input) {
                showError("请先输入短视频分享链接");
                return;
            }

            errorBox.classList.add('hidden');
            resultDiv.classList.add('hidden');
            loading.classList.remove('hidden');
            btn.disabled = true;

            const payload = { url: input, token: API_TOKEN };
            const finalUrl = useProxy ? (PROXY_URL + encodeURIComponent(TARGET_URL)) : TARGET_URL;

            try {
                const response = await fetch(finalUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

                const res = await response.json();
                if (res.success && res.data) {
                    displayResult(res.data);
                } else {
                    showError(res.message || "解析失败，请检查秘钥或链接");
                }
            } catch (err) {
                console.error("Fetch Error:", err);
                showError("解析出错: " + err.message + "。请确认秘钥是否正确及是否开启中转模式。");
            } finally {
                loading.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function displayResult(data) {
            document.getElementById('result').classList.remove('hidden');
            const player = document.getElementById('player');
            const quotaInfo = document.getElementById('quotaInfo');
            
            document.getElementById('title').innerText = data.title || "无标题视频";
            document.getElementById('likes').innerText = data.like || 0;
            document.getElementById('createTime').innerText = data.createTime || "未知";
            
            quotaInfo.classList.remove('hidden');
            document.getElementById('leftTimes').innerText = data.leftTimes || 0;
            
            currentVideoUrl = data.videoUrls;
            player.src = currentVideoUrl;
            player.poster = data.coverUrls;

            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }

        function showError(msg) {
            const errorBox = document.getElementById('errorBox');
            document.getElementById('errorMsg').innerText = msg;
            errorBox.classList.remove('hidden');
        }

        function downloadVideo() {
            if (!currentVideoUrl) return;
            window.open(currentVideoUrl, '_blank');
        }

        document.getElementById('videoUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') parseVideo();
        });
    </script>
</body>
</html>
