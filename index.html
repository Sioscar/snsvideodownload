<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- 核心：全局禁用 Referrer 绕过平台防盗链 -->
    <meta name="referrer" content="no-referrer">
    <title>Video Downloader Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .video-container video {
            max-height: 500px;
            width: 100%;
            border-radius: 12px;
            background: #000;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800 flex flex-col relative">

    <nav class="p-4 flex justify-end">
        <button onclick="toggleSettings()" class="text-gray-500 hover:text-blue-600 transition-colors p-3 rounded-full active:bg-gray-200" id="navSettingsBtn">
            <i class="fas fa-cog text-2xl"></i>
        </button>
    </nav>

    <div class="flex-grow max-w-4xl mx-auto px-4 w-full">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2" id="ui-mainTitle">
                <i class="fas fa-video text-blue-600 mr-2"></i>短视频去水印解析
            </h1>
            <p class="text-gray-500 text-sm" id="ui-subTitle">支持抖音、小红书、B站、快手等主流平台</p>
        </div>

        <div id="settingsPanel" class="hidden mb-8 transition-all duration-300">
            <div class="glass-morphism p-5 rounded-2xl border-2 border-blue-100 shadow-inner">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-gray-800" id="ui-configTitle">
                    <i class="fas fa-key text-yellow-500"></i> API 秘钥配置
                </h3>
                <div class="flex flex-col gap-3">
                    <input type="password" id="apiTokenInput" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <button onclick="saveToken()" id="ui-saveBtn" class="w-full bg-gray-800 hover:bg-black text-white px-6 py-3 rounded-xl font-bold transition-all shadow-lg active:scale-95">保存设置</button>
                </div>
            </div>
        </div>

        <div class="glass-morphism p-6 rounded-2xl shadow-xl mb-8">
            <div class="flex flex-col gap-4">
                <input type="text" id="videoUrl" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-base">
                <button onclick="parseVideo()" id="parseBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-medium transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                    <i class="fas fa-magic"></i> <span id="ui-parseBtnText">立即解析</span>
                </button>
            </div>
            <div class="mt-4 flex items-start gap-2 text-xs text-gray-400 justify-center">
                <input type="checkbox" id="useProxy" checked class="mt-0.5">
                <label for="useProxy" id="ui-proxyLabel">使用中转代理模式（推荐开启）</label>
            </div>
        </div>

        <div id="loading" class="hidden flex-col items-center justify-center py-20">
            <div class="loading-spinner mb-4"></div>
            <p id="ui-loadingStatus" class="text-gray-500">正在努力解析中...</p>
        </div>

        <div id="result" class="hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="video-container rounded-2xl overflow-hidden shadow-2xl flex items-center justify-center">
                    <video id="player" controls poster="" class="w-full h-full" playsinline webkit-playsinline referrerpolicy="no-referrer">
                    </video>
                </div>

                <div class="space-y-6 flex flex-col justify-between">
                    <div>
                        <h2 id="title" class="text-xl font-semibold leading-relaxed mb-4 text-gray-800">Video Title</h2>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 text-center">
                                <p class="text-gray-400 mb-1 text-xs"><i class="fas fa-heart text-red-400 mr-1"></i> <span id="ui-likesLabel">点赞</span></p>
                                <p id="likes" class="text-lg font-bold text-gray-800">0</p>
                            </div>
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 text-center">
                                <p class="text-gray-400 mb-1 text-xs"><i class="fas fa-clock text-blue-400 mr-1"></i> <span id="ui-timeLabel">时间</span></p>
                                <p id="createTime" class="text-sm font-bold text-gray-700 mt-1 truncate">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <button id="downloadBtn" onclick="downloadVideo()" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg active:scale-95">
                            <i class="fas fa-download"></i> <span id="ui-downloadBtn">下载视频</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="errorBox" class="hidden bg-red-50 text-red-600 p-4 rounded-xl border border-red-200 text-center text-sm">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorMsg"></span>
        </div>
    </div>

    <footer class="py-6 text-center text-gray-400 text-xs mt-auto">
        <span id="quotaInfo" class="hidden"><span id="ui-quotaLabel">API 剩余次数</span>: <span id="leftTimes">0</span></span>
        <p class="mt-1">フライメディア社内用</p>
    </footer>

    <script>
        const i18n = {
            'zh-CN': {
                mainTitle: '短视频去水印解析',
                subTitle: '支持主流平台',
                configTitle: 'API 秘钥配置',
                inputPlaceholder: '请粘贴分享链接...',
                tokenPlaceholder: '请输入您的 API Token',
                saveBtn: '保存设置',
                parseBtn: '立即解析',
                proxyLabel: '使用中转代理模式（推荐开启）',
                loading: '正在努力解析中...',
                likes: '点赞',
                time: '发布时间',
                download: '下载无水印视频',
                downloading: '准备下载中...',
                quota: 'API 剩余次数',
                saveSuccess: '保存成功！',
                parseErr: '解析失败，请检查链接或秘钥。',
                dlFail: '下载失败：受目标平台跨域限制。请在打开的新页面长按视频选择“保存视频”。'
            }
        };

        let currentLang = 'zh-CN';
        const TARGET_URL = "https://www.xiazaitool.com/api/parseVideoUrl";
        let currentVideoUrl = "";

        window.onload = () => {
            initLanguage();
            const savedToken = localStorage.getItem('DOG_API_TOKEN');
            if (savedToken) document.getElementById('apiTokenInput').value = savedToken;
            else document.getElementById('settingsPanel').classList.remove('hidden');
        };

        function initLanguage() {
            const dict = i18n[currentLang];
            document.getElementById('ui-mainTitle').innerHTML = `<i class="fas fa-video text-blue-600 mr-2"></i>${dict.mainTitle}`;
            document.getElementById('ui-subTitle').innerText = dict.subTitle;
            document.getElementById('ui-configTitle').innerHTML = `<i class="fas fa-key text-yellow-500"></i> ${dict.configTitle}`;
            document.getElementById('videoUrl').placeholder = dict.inputPlaceholder;
            document.getElementById('apiTokenInput').placeholder = dict.tokenPlaceholder;
            document.getElementById('ui-saveBtn').innerText = dict.saveBtn;
            document.getElementById('ui-parseBtnText').innerText = dict.parseBtn;
            document.getElementById('ui-proxyLabel').innerText = dict.proxyLabel;
            document.getElementById('ui-loadingStatus').innerText = dict.loading;
            document.getElementById('ui-likesLabel').innerText = dict.likes;
            document.getElementById('ui-timeLabel').innerText = dict.time;
            document.getElementById('ui-downloadBtn').innerText = dict.download;
            document.getElementById('ui-quotaLabel').innerText = dict.quota;
        }

        function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('hidden'); }

        function saveToken() {
            const token = document.getElementById('apiTokenInput').value.trim();
            if (!token) return;
            localStorage.setItem('DOG_API_TOKEN', token);
            alert(i18n[currentLang].saveSuccess);
            document.getElementById('settingsPanel').classList.add('hidden');
        }

        async function parseVideo() {
            const input = document.getElementById('videoUrl').value.trim();
            const useProxy = document.getElementById('useProxy').checked;
            const API_TOKEN = localStorage.getItem('DOG_API_TOKEN');
            const dict = i18n[currentLang];

            if (!API_TOKEN) { toggleSettings(); showError(dict.errNoToken); return; }
            if (!input) { showError(dict.errNoUrl); return; }

            document.getElementById('errorBox').classList.add('hidden');
            document.getElementById('result').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('parseBtn').disabled = true;

            try {
                const cleanInput = input.replace(/[\u4e00-\u9fa5]/g, '').trim(); 
                // 解析请求也尝试通过代理，防止 API 本身被某些环境屏蔽
                const proxyPrefix = useProxy ? "https://corsproxy.io/?" : "";
                const response = await fetch(proxyPrefix + TARGET_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: cleanInput, token: API_TOKEN })
                });

                const res = await response.json();
                if (res.success && res.data) {
                    displayResult(res.data);
                } else {
                    showError(res.message || dict.parseErr);
                }
            } catch (err) {
                showError(dict.parseErr + " (Network Error)");
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('parseBtn').disabled = false;
            }
        }

        function displayResult(data) {
            document.getElementById('result').classList.remove('hidden');
            document.getElementById('title').innerText = data.title || "Video";
            document.getElementById('likes').innerText = data.like || 0;
            document.getElementById('createTime').innerText = data.createTime || "-";
            document.getElementById('quotaInfo').classList.remove('hidden');
            document.getElementById('leftTimes').innerText = data.leftTimes || 0;
            
            currentVideoUrl = data.videoUrls;
            const player = document.getElementById('player');
            player.src = currentVideoUrl;
            player.poster = data.coverUrls;
            
            setTimeout(() => {
                document.getElementById('result').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function showError(msg) {
            document.getElementById('errorMsg').innerText = msg;
            document.getElementById('errorBox').classList.remove('hidden');
        }

        async function downloadVideo() {
            if (!currentVideoUrl) return;
            const btn = document.getElementById('downloadBtn');
            const originalIcon = btn.innerHTML;
            const dict = i18n[currentLang];

            const now = new Date();
            const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
            let title = document.getElementById('title').innerText || 'video';
            title = title.replace(/[\\/:*?"<>|]/g, '_').substring(0, 50).trim();
            const filename = `${dateStr}_${title}.mp4`;

            try {
                btn.disabled = true;
                btn.innerHTML = `<div class="loading-spinner w-5 h-5 border-2 inline-block mr-2" style="width:1.2rem;height:1.2rem;border-width:2px;"></div> ${dict.downloading}`;

                // 尝试多个代理绕过限制
                const proxyList = [
                    `https://corsproxy.io/?${encodeURIComponent(currentVideoUrl)}`,
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(currentVideoUrl)}`
                ];

                let blob = null;
                for (let proxyUrl of proxyList) {
                    try {
                        const response = await fetch(proxyUrl, { referrerPolicy: "no-referrer" });
                        if (response.ok) {
                            blob = await response.blob();
                            break;
                        }
                    } catch (e) { console.warn("Proxy failed:", proxyUrl); }
                }

                if (!blob) throw new Error('Download failed');

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename; // 此时 href 是 blob 协议，download 属性必定生效
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }, 200);

            } catch (err) {
                console.error("Final download error:", err);
                showError(dict.dlFail);
                // 仅作为最后保底，若跳转则无法控制文件名
                window.open(currentVideoUrl, '_blank');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalIcon;
            }
        }

        document.getElementById('videoUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') parseVideo();
        });
    </script>
</body>
</html>
