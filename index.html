<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Downloader Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .video-container video {
            max-height: 500px;
            width: 100%;
            border-radius: 12px;
            background: #000;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800 flex flex-col">

    <!-- 导航栏/头部 -->
    <nav class="p-4 flex justify-end">
        <button onclick="toggleSettings()" class="text-gray-400 hover:text-blue-600 transition-colors p-2" id="navSettingsBtn">
            <i class="fas fa-cog text-xl"></i>
        </button>
    </nav>

    <div class="flex-grow max-w-4xl mx-auto px-4 py-4 w-full">
        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-gray-900 mb-2" id="ui-mainTitle">
                <i class="fas fa-video text-blue-600 mr-2"></i>短视频去水印解析
            </h1>
            <p class="text-gray-500 text-sm" id="ui-subTitle">支持主流平台 | 个人私有化部署版</p>
        </div>

        <!-- 秘钥配置区域 -->
        <div id="settingsPanel" class="hidden glass-morphism p-6 rounded-2xl shadow-lg mb-8 border-2 border-blue-100">
            <h3 class="font-bold mb-4 flex items-center gap-2" id="ui-configTitle">
                <i class="fas fa-key text-yellow-500"></i> API 秘钥配置
            </h3>
            <div class="flex flex-col md:flex-row gap-4">
                <input 
                    type="password" 
                    id="apiTokenInput" 
                    class="flex-1 px-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <button 
                    onclick="saveToken()" 
                    id="ui-saveBtn"
                    class="bg-gray-800 hover:bg-black text-white px-6 py-2 rounded-lg transition-all"
                >保存设置</button>
            </div>
            <p class="mt-2 text-xs text-gray-400 italic" id="ui-configHint">* 秘钥将保存在浏览器本地，不会上传到服务器。</p>
        </div>

        <!-- 输入区域 -->
        <div class="glass-morphism p-6 rounded-2xl shadow-xl mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <input 
                    type="text" 
                    id="videoUrl" 
                    class="flex-1 px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                >
                <button 
                    onclick="parseVideo()" 
                    id="parseBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-medium transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2"
                >
                    <i class="fas fa-magic"></i> <span id="ui-parseBtnText">立即解析</span>
                </button>
            </div>
            <div class="mt-3 flex items-center gap-2 text-xs text-gray-400">
                <input type="checkbox" id="useProxy" checked>
                <label for="useProxy" id="ui-proxyLabel">使用中转代理模式（解决跨域限制）</label>
            </div>
        </div>

        <!-- 加载中 -->
        <div id="loading" class="hidden flex-col items-center justify-center py-20">
            <div class="loading-spinner mb-4"></div>
            <p id="ui-loadingStatus" class="text-gray-500">正在努力解析中...</p>
        </div>

        <!-- 结果展示区域 -->
        <div id="result" class="hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="video-container rounded-2xl overflow-hidden shadow-2xl flex items-center justify-center">
                    <video id="player" controls poster="" class="w-full h-full" playsinline>
                    </video>
                </div>

                <div class="space-y-6 flex flex-col justify-between">
                    <div>
                        <h2 id="title" class="text-xl font-semibold leading-relaxed mb-4">Video Title</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                <p class="text-gray-400 mb-1"><i class="fas fa-heart mr-1"></i> <span id="ui-likesLabel">点赞数</span></p>
                                <p id="likes" class="text-lg font-bold text-red-500">0</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                <p class="text-gray-400 mb-1"><i class="fas fa-clock mr-1"></i> <span id="ui-timeLabel">发布时间</span></p>
                                <p id="createTime" class="text-lg font-bold text-gray-700">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <button onclick="downloadVideo()" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg active:scale-95">
                            <i class="fas fa-download"></i> <span id="ui-downloadBtn">下载无水印视频</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 错误提示 -->
        <div id="errorBox" class="hidden bg-red-50 text-red-600 p-4 rounded-xl border border-red-200 text-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorMsg"></span>
        </div>
    </div>

    <footer class="py-6 text-center text-gray-400 text-xs mt-auto">
        <span id="quotaInfo" class="hidden"><span id="ui-quotaLabel">API 剩余解析次数</span>: <span id="leftTimes">0</span></span>
        <p class="mt-1" id="ui-footerNote">本工具仅供学习交流使用</p>
    </footer>

    <script>
        const i18n = {
            'zh-CN': {
                mainTitle: '短视频去水印解析',
                subTitle: '支持主流平台 | 个人私有化部署版',
                configTitle: 'API 秘钥配置',
                inputPlaceholder: '请粘贴分享链接...',
                tokenPlaceholder: '请输入您的下载狗 API Token',
                saveBtn: '保存设置',
                configHint: '* 秘钥将保存在浏览器本地，不会上传到 GitHub 仓库。',
                parseBtn: '立即解析',
                proxyLabel: '使用中转代理模式（解决跨域限制）',
                loading: '正在努力解析中...',
                likes: '点赞数',
                time: '发布时间',
                download: '下载无水印视频',
                quota: 'API 剩余解析次数',
                footerNote: '本工具仅供学习交流使用',
                errNoToken: '请先点击右上角齿轮设置您的 API 秘钥',
                errNoUrl: '请先输入短视频分享链接',
                saveSuccess: '秘钥保存成功！',
                parseErr: '解析出错，请确认秘钥和链接是否正确。'
            },
            'zh-TW': {
                mainTitle: '短視頻去水印解析',
                subTitle: '支持主流平台 | 個人私有化部署版',
                configTitle: 'API 秘鑰配置',
                inputPlaceholder: '請粘貼分享鏈接...',
                tokenPlaceholder: '請輸入您的下載狗 API Token',
                saveBtn: '保存設置',
                configHint: '* 秘鑰將保存在瀏覽器本地，不會上傳到 GitHub 倉庫。',
                parseBtn: '立即解析',
                proxyLabel: '使用中轉代理模式（解決跨域限制）',
                loading: '正在努力解析中...',
                likes: '點讚數',
                time: '發布時間',
                download: '下載無水印視頻',
                quota: 'API 剩餘解析次數',
                footerNote: '本工具僅供學習交流使用',
                errNoToken: '請先點擊右上角齒輪設置您的 API 秘鑰',
                errNoUrl: '請先輸入短視頻分享鏈接',
                saveSuccess: '秘鑰保存成功！',
                parseErr: '解析出錯，請確認秘鑰和鏈接是否正確。'
            },
            'en': {
                mainTitle: 'Video Watermark Remover',
                subTitle: 'Support major platforms | Private Edition',
                configTitle: 'API Key Configuration',
                inputPlaceholder: 'Paste video link here...',
                tokenPlaceholder: 'Enter your API Token',
                saveBtn: 'Save Settings',
                configHint: '* Key is stored locally and will not be uploaded to GitHub.',
                parseBtn: 'Parse Now',
                proxyLabel: 'Use Proxy Mode (Fix CORS issues)',
                loading: 'Parsing video, please wait...',
                likes: 'Likes',
                time: 'Release Time',
                download: 'Download No-Watermark Video',
                quota: 'Remaining API Quota',
                footerNote: 'For educational purposes only',
                errNoToken: 'Please set your API key in the settings first',
                errNoUrl: 'Please paste a valid video link',
                saveSuccess: 'Settings saved successfully!',
                parseErr: 'Parsing failed. Please check your key or URL.'
            },
            'ja': {
                mainTitle: '短動画ロゴ消去解析',
                subTitle: '主要プラットフォーム対応 | 個人版',
                configTitle: 'APIキー設定',
                inputPlaceholder: '動画リンクを貼り付けてください...',
                tokenPlaceholder: 'APIトークンを入力してください',
                saveBtn: '設定を保存',
                configHint: '* キーはローカルに保存され、GitHubにはアップロードされません。',
                parseBtn: '解析開始',
                proxyLabel: 'プロキシモードを使用（CORS制限回避）',
                loading: '解析中、しばらくお待ちください...',
                likes: 'いいね数',
                time: '投稿時間',
                download: 'ロゴなし動画を保存',
                quota: 'API残り回数',
                footerNote: '学習交流目的のみ',
                errNoToken: '右上の歯車アイコンからAPIキーを設定してください',
                errNoUrl: '動画リンクを入力してください',
                saveSuccess: '設定を保存しました！',
                parseErr: '解析に失敗しました。キーまたはリンクを確認してください。'
            }
        };

        let currentLang = 'en';

        // 语言检测与应用
        function initLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith('zh-CN')) currentLang = 'zh-CN';
            else if (browserLang.startsWith('zh-TW') || browserLang.startsWith('zh-HK')) currentLang = 'zh-TW';
            else if (browserLang.startsWith('ja')) currentLang = 'ja';
            else currentLang = 'en';

            const dict = i18n[currentLang];
            document.getElementById('ui-mainTitle').innerHTML = `<i class="fas fa-video text-blue-600 mr-2"></i>${dict.mainTitle}`;
            document.getElementById('ui-subTitle').innerText = dict.subTitle;
            document.getElementById('ui-configTitle').innerHTML = `<i class="fas fa-key text-yellow-500"></i> ${dict.configTitle}`;
            document.getElementById('videoUrl').placeholder = dict.inputPlaceholder;
            document.getElementById('apiTokenInput').placeholder = dict.tokenPlaceholder;
            document.getElementById('ui-saveBtn').innerText = dict.saveBtn;
            document.getElementById('ui-configHint').innerText = dict.configHint;
            document.getElementById('ui-parseBtnText').innerText = dict.parseBtn;
            document.getElementById('ui-proxyLabel').innerText = dict.proxyLabel;
            document.getElementById('ui-loadingStatus').innerText = dict.loading;
            document.getElementById('ui-likesLabel').innerText = dict.likes;
            document.getElementById('ui-timeLabel').innerText = dict.time;
            document.getElementById('ui-downloadBtn').innerText = dict.download;
            document.getElementById('ui-quotaLabel').innerText = dict.quota;
            document.getElementById('ui-footerNote').innerText = dict.footerNote;
            document.getElementById('navSettingsBtn').title = dict.configTitle;
        }

        const TARGET_URL = "https://www.xiazaitool.com/api/parseVideoUrl";
        const PROXY_URL = "https://corsproxy.io/?"; 
        let currentVideoUrl = "";

        window.onload = () => {
            initLanguage();
            const savedToken = localStorage.getItem('DOG_API_TOKEN');
            if (!savedToken) {
                document.getElementById('settingsPanel').classList.remove('hidden');
            } else {
                document.getElementById('apiTokenInput').value = savedToken;
            }
        };

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('hidden');
        }

        function saveToken() {
            const token = document.getElementById('apiTokenInput').value.trim();
            if (!token) return;
            localStorage.setItem('DOG_API_TOKEN', token);
            alert(i18n[currentLang].saveSuccess);
            document.getElementById('settingsPanel').classList.add('hidden');
        }

        async function parseVideo() {
            const input = document.getElementById('videoUrl').value.trim();
            const useProxy = document.getElementById('useProxy').checked;
            const btn = document.getElementById('parseBtn');
            const resultDiv = document.getElementById('result');
            const loading = document.getElementById('loading');
            const errorBox = document.getElementById('errorBox');
            
            const API_TOKEN = localStorage.getItem('DOG_API_TOKEN');
            const dict = i18n[currentLang];

            if (!API_TOKEN) {
                document.getElementById('settingsPanel').classList.remove('hidden');
                showError(dict.errNoToken);
                return;
            }

            if (!input) {
                showError(dict.errNoUrl);
                return;
            }

            errorBox.classList.add('hidden');
            resultDiv.classList.add('hidden');
            loading.classList.remove('hidden');
            btn.disabled = true;

            try {
                const finalUrl = useProxy ? (PROXY_URL + encodeURIComponent(TARGET_URL)) : TARGET_URL;
                const response = await fetch(finalUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: input, token: API_TOKEN })
                });

                const res = await response.json();
                if (res.success && res.data) {
                    displayResult(res.data);
                } else {
                    showError(res.message || dict.parseErr);
                }
            } catch (err) {
                showError(dict.parseErr + " (Network Error)");
            } finally {
                loading.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function displayResult(data) {
            document.getElementById('result').classList.remove('hidden');
            document.getElementById('title').innerText = data.title || "Video";
            document.getElementById('likes').innerText = data.like || 0;
            document.getElementById('createTime').innerText = data.createTime || "-";
            document.getElementById('quotaInfo').classList.remove('hidden');
            document.getElementById('leftTimes').innerText = data.leftTimes || 0;
            
            currentVideoUrl = data.videoUrls;
            const player = document.getElementById('player');
            player.src = currentVideoUrl;
            player.poster = data.coverUrls;
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }

        function showError(msg) {
            const errorBox = document.getElementById('errorBox');
            document.getElementById('errorMsg').innerText = msg;
            errorBox.classList.remove('hidden');
        }

        function downloadVideo() {
            if (currentVideoUrl) window.open(currentVideoUrl, '_blank');
        }

        document.getElementById('videoUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') parseVideo();
        });
    </script>
</body>
</html>
